<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Set password</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h3 class="mb-2" id="title">Activar cuenta</h3>
          <p class="text-muted mb-4" id="subtitle">Define tu contrase√±a para activar tu cuenta.</p>

          <div id="alert" class="alert d-none" role="alert"></div>

          <form id="setPassForm" novalidate>
            <div class="mb-3" id="tokenGroup">
              <label class="form-label">Token</label>
              <input type="text" class="form-control" id="token" required />
              <div class="form-text">Si vienes desde un link, se autocompleta con ?token=...</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Nueva contrase√±a</label>
              <input type="password" class="form-control" id="newPassword" required minlength="6" />
              <div class="form-text">M√≠nimo 6 caracteres.</div>
            </div>

            <button class="btn btn-success w-100" id="btnSubmit" type="submit">Guardar contrase√±a</button>
          </form>

          <div class="d-flex justify-content-between mt-4">
            <a href="/index.html" class="text-decoration-none">Ir al login</a>
            <a href="/register.html" class="text-decoration-none">Crear cuenta</a>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "";

  const alertBox = document.getElementById("alert");
  const btn = document.getElementById("btnSubmit");
  const tokenEl = document.getElementById("token");
  const tokenGroup = document.getElementById("tokenGroup");
  const newPassEl = document.getElementById("newPassword");

  function showAlert(type, msg) {
    alertBox.className = `alert alert-${type}`;
    alertBox.textContent = msg;
    alertBox.classList.remove("d-none");
  }

  function setLoading(isLoading) {
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "Guardando..." : "Guardar contrase√±a";
  }

  async function safeJson(res) {
    try { return await res.json(); } catch { return null; }
  }

  const params = new URLSearchParams(window.location.search);
  const qToken = params.get("token");
  const mode = params.get("mode"); // "recovery" o null


  if (mode === "recovery") {
    document.getElementById("title").textContent = "Recuperar contrase√±a";
    document.getElementById("subtitle").textContent = "Define una nueva contrase√±a para tu cuenta.";
  }

  if (qToken) {
    tokenEl.value = qToken;
    tokenGroup.classList.add("d-none");
  }

  document.getElementById("setPassForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    alertBox.classList.add("d-none");

    const token = (tokenEl.value || "").trim();
    const newPassword = newPassEl.value || "";


    if (!token) return showAlert("warning", "‚ö†Ô∏è Token es requerido.");
    if (!newPassword) return showAlert("warning", "‚ö†Ô∏è La contrase√±a es requerida.");
    if (newPassword.length < 6) return showAlert("warning", "‚ö†Ô∏è La contrase√±a debe tener m√≠nimo 6 caracteres.");

    // Endpoint seg√∫n modo
    const endpoint = (mode === "recovery")
            ? `/users/recovery-set-password?token=${encodeURIComponent(token)}`
            : `/users/set-password?token=${encodeURIComponent(token)}`;

    setLoading(true);

    try {
      const res = await fetch(`${API_BASE}${endpoint}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ newPassword })
      });

      const data = await safeJson(res);

      if (!res.ok) {
        if (res.status === 400) return showAlert("danger", data?.message || "Solicitud inv√°lida.");
        if (res.status === 401) return showAlert("danger", "Token inv√°lido o credenciales no v√°lidas.");
        if (res.status === 403) return showAlert("danger", "Token expirado o ya usado.");
        return showAlert("danger", data?.message || `Error (${res.status}) guardando contrase√±a`);
      }

      showAlert("success", data?.message || "‚úÖ Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.");

      setTimeout(() => {
        window.location.href = "/index.html";
      }, 1200);

    } catch (err) {
      showAlert("danger", "üåê Error de red o servidor no disponible.");
    } finally {
      setLoading(false);
    }
  });
</script>
</body>
</html>
